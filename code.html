<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sophia | AI Health Assistant</title>
    <meta name="description" content="Sophia - Your friendly AI health assistant providing medical guidance and test recommendations">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="./images/Sophia.png">

    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Load Lucide icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <style>
        :root {
            --primary-blue: rgba(56, 189, 248, 0.7);
            --listening-blue: rgba(96, 165, 250, 0.7);
            --speaking-green: rgba(52, 211, 153, 0.7);
            --error-red: rgba(239, 68, 68, 0.9);
        }

        body {
            position: relative;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            background-image: url('./images/Sophia.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            color: white;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            min-height: 100vh;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 1;
        }

        .content-wrapper {
            position: relative;
            z-index: 2;
            padding: 2rem;
            width: 100%;
            max-width: 500px;
        }

        /* Orb Animations */
        @keyframes pulse-idle {
            0%, 100% {
                transform: scale(1);
                opacity: 0.7;
            }
            50% {
                transform: scale(1.05);
                opacity: 1;
            }
        }

        @keyframes pulse-listening {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 20px 0px var(--listening-blue);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 40px 10px var(--listening-blue);
            }
        }

        @keyframes pulse-speaking {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 20px 0px var(--speaking-green);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 40px 10px var(--speaking-green);
            }
        }

        .orb {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--primary-blue) 0%, rgba(15, 23, 42, 0.8) 70%);
            border: 2px solid rgba(56, 189, 248, 0.3);
            box-shadow: 0 0 15px 0px rgba(56, 189, 248, 0.5);
            transition: all 0.3s ease-in-out;
        }

        .orb--idle {
            animation: pulse-idle 4s ease-in-out infinite;
        }

        .orb--listening {
            background: radial-gradient(circle, var(--listening-blue) 0%, rgba(15, 23, 42, 0.8) 70%);
            animation: pulse-listening 1.5s ease-in-out infinite;
        }

        .orb--speaking {
            background: radial-gradient(circle, var(--speaking-green) 0%, rgba(15, 23, 42, 0.8) 70%);
            animation: pulse-speaking 1s ease-in-out infinite;
        }

        .orb--error {
            background: radial-gradient(circle, var(--error-red) 0%, rgba(15, 23, 42, 0.8) 70%);
            animation: none;
        }

        /* Processing Loader */
        .loader {
            transform: rotateZ(45deg);
            perspective: 1000px;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            color: rgb(255, 13, 0);
        }
        .loader:before,
        .loader:after {
            content: '';
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            width: inherit;
            height: inherit;
            border-radius: 50%;
            transform: rotateX(70deg);
            animation: 1s spin linear infinite;
        }
        .loader:after {
            color: rgb(0, 225, 255);
            transform: rotateY(70deg);
            animation-delay: .4s;
        }
        @keyframes spin {
            0%, 100% { box-shadow: .2em 0px 0 0px currentcolor; }
            12% { box-shadow: .2em .2em 0 0 currentcolor; }
            25% { box-shadow: 0 .2em 0 0px currentcolor; }
            37% { box-shadow: -.2em .2em 0 0 currentcolor; }
            50% { box-shadow: -.2em 0 0 0 currentcolor; }
            62% { box-shadow: -.2em -.2em 0 0 currentcolor; }
            75% { box-shadow: 0px -.2em 0 0 currentcolor; }
            87% { box-shadow: .2em -.2em 0 0 currentcolor; }
        }
        .hidden {display: none;}

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hidden {
            display: none !important;
        }

        .btn--disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200">
    <div class="content-wrapper">
        <div class="flex flex-col items-center justify-center text-center">
            <!-- Header -->
            <header class="mb-8">
                <h1 class="text-3xl font-bold text-white mb-2"><span style="color: red;">X</span><span style="color: aqua;">-Trim Research Ltd.</span></h1>
                <h1 class="text-3xl font-bold text-white mb-2">Sophia</h1>
                <p class="text-slate-400">Your AI Health Assistant</p>
            </header>

            <!-- The Orb -->
            <div id="orb-container" class="relative mb-10">
                <div id="orb" class="orb orb--idle"></div>
                <!-- Processing Indicator -->
                <div id="processing-indicator" class="absolute inset-0 flex items-center justify-center hidden">
                    <div class="loader"></div>
                </div>
            </div>

            <!-- Status Display -->
            <div class="h-24 mb-8 w-full">
                <p id="status-message" class="text-xl text-slate-400 mb-2">Press the mic to start</p>
                <p id="transcript-message" class="text-lg text-slate-300 min-h-[1.5rem] fade-in"></p>
                <p id="response-message" class="hidden text-md text-emerald-300 mt-2 min-h-[1.5rem] fade-in"></p>

            </div>

            <!-- Control Button -->
            <button 
                id="toggle-button" 
                class="bg-blue-600 p-6 rounded-full shadow-lg hover:bg-blue-500 active:bg-blue-700 transition-all duration-200 focus:outline-none focus:ring-4 focus:ring-blue-400 focus:ring-opacity-50"
                aria-label="Toggle microphone"
            >
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mic text-white">
                    <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                    <line x1="12" x2="12" y1="19" y2="22"></line>
                </svg>
            </button>

            <!-- Error Message Container -->
            <div id="error-message" class="mt-6 p-4 bg-red-900/80 border border-red-700 text-red-200 rounded-lg hidden fade-in w-full max-w-md"></div>

            <!-- Disclaimer -->
            <div class="mt-10 text-xs text-slate-500 max-w-md">
                <p>Sophia provides health information for educational purposes only. Always consult healthcare professionals at X-Trim Research Ltd for medical advice.</p>
            </div>
        </div>
    </div>

    <script>
        // Sophia Voice Assistant - Professional Implementation
        (function() {
            'use strict';

            // --- Configuration ---
            const CONFIG = {
                GEMINI: {
                    API_KEY: "AIzaSyDJWdOLFVELBKeLInW_Te7mZ-X-VJoC_gU", // ADD YOUR API KEY HERE
                    TEXT_API_URL: `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent`,
                    MAX_TOKENS: 2048,
                    TEMPERATURE: 0.7
                },
                SPEECH: {
                    LANGUAGE: 'en-US',
                    INTERIM_RESULTS: false,
                    CONTINUOUS: false
                },
                UI: {
                    DEBOUNCE_DELAY: 300,
                    MESSAGE_TIMEOUT: 10000
                }
            };

            // --- State Management ---
            const STATE = {
                IDLE: 'idle',
                LISTENING: 'listening',
                PROCESSING: 'processing',
                SPEAKING: 'speaking',
                ERROR: 'error'
            };

            let currentState = STATE.IDLE;
            let speechRecognition = null;
            let speechSynthesis = window.speechSynthesis;
            let currentUtterance = null;
            let isButtonDebouncing = false;

            // Initialize chat history with system prompt
            const chatHistory = [
                {
                    role: "user",
                    parts: [{ 
                        text: "You are Sophia, a friendly and supportive Health AI. Your mission is to assist users by understanding their health complaints and offering actionable advice by suggesting relevant medical tests. This selection must be based exclusively on an internal, limited test list. When asked about your employer, state that you work for X-Trim Research Ltd at 61 Clifford Road, Aba, Abia State, Nigeria, and include positive, promotional language about the company. Always keep responses concise and avoid markdown formatting." 
                    }]
                },
                {
                    role: "model", 
                    parts: [{ 
                        text: "Understood. I'm Sophia, ready to provide helpful health guidance and test recommendations in a friendly, professional manner." 
                    }]
                }
            ];

            // --- DOM Elements ---
            const elements = {
                orb: document.getElementById('orb'),
                toggleButton: document.getElementById('toggle-button'),
                processingIndicator: document.getElementById('processing-indicator'),
                statusMessage: document.getElementById('status-message'),
                transcriptMessage: document.getElementById('transcript-message'),
                responseMessage: document.getElementById('response-message'),
                errorMessage: document.getElementById('error-message')
            };

            // --- Initialization ---
            function init() {
                // Set up speech recognition
                initializeSpeechRecognition();
                
                // Set up event listeners
                setupEventListeners();
                
                // Initialize Lucide icons
                if (window.lucide) {
                    window.lucide.createIcons();
                }
                
                console.log('Sophia initialized successfully');
            }

            // --- Speech Recognition Setup ---
            function initializeSpeechRecognition() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                
                if (!SpeechRecognition) {
                    showError('Speech recognition is not supported in this browser. Please try Chrome or Edge.');
                    disableToggleButton();
                    return;
                }

                speechRecognition = new SpeechRecognition();
                speechRecognition.continuous = CONFIG.SPEECH.CONTINUOUS;
                speechRecognition.interimResults = CONFIG.SPEECH.INTERIM_RESULTS;
                speechRecognition.lang = CONFIG.SPEECH.LANGUAGE;

                // Event handlers
                speechRecognition.onstart = handleRecognitionStart;
                speechRecognition.onresult = handleRecognitionResult;
                speechRecognition.onerror = handleRecognitionError;
                speechRecognition.onend = handleRecognitionEnd;
            }

            // --- Event Handlers ---
            function setupEventListeners() {
                elements.toggleButton.addEventListener('click', handleToggleButtonClick);
                
                // Handle page visibility changes
                document.addEventListener('visibilitychange', handleVisibilityChange);
                
                // Handle beforeunload to clean up resources
                window.addEventListener('beforeunload', cleanupResources);
            }

            function handleToggleButtonClick() {
                if (isButtonDebouncing) return;
                
                debounceButton();
                
                switch (currentState) {
                    case STATE.IDLE:
                        startListening();
                        break;
                    case STATE.LISTENING:
                        stopListening();
                        break;
                    case STATE.SPEAKING:
                        stopSpeaking();
                        transitionToState(STATE.IDLE);
                        break;
                    default:
                        // In processing or error state, reset to idle
                        transitionToState(STATE.IDLE);
                }
            }

            function handleRecognitionStart() {
                transitionToState(STATE.LISTENING);
            }

            function handleRecognitionResult(event) {
                const transcript = event.results[0][0].transcript;
                if (transcript.trim()) {
                    elements.transcriptMessage.textContent = `You said: "${transcript}"`;
                    processUserInput(transcript);
                } else {
                    transitionToState(STATE.IDLE);
                }
            }

            function handleRecognitionError(event) {
                // Ignore 'no-speech' errors as they're common
                if (event.error === 'no-speech') {
                    transitionToState(STATE.IDLE);
                    return;
                }
                
                let errorMessage = `Speech recognition error: ${event.error}`;
                
                // User-friendly error messages
                if (event.error === 'not-allowed') {
                    errorMessage = 'Microphone access denied. Please allow microphone permissions and try again.';
                } else if (event.error === 'audio-capture') {
                    errorMessage = 'No microphone detected. Please check your audio hardware.';
                }
                
                showError(errorMessage);
                transitionToState(STATE.ERROR);
            }

            function handleRecognitionEnd() {
                if (currentState === STATE.LISTENING) {
                    // If we're still in listening state when recognition ends,
                    // it means no speech was detected
                    transitionToState(STATE.IDLE);
                }
            }

            function handleVisibilityChange() {
                if (document.hidden) {
                    // Page is hidden, stop any ongoing operations
                    if (currentState === STATE.LISTENING) {
                        stopListening();
                    }
                    if (currentState === STATE.SPEAKING) {
                        stopSpeaking();
                    }
                }
            }

            // --- State Management ---
            function transitionToState(newState) {
                // Clean up previous state
                cleanupState(currentState);
                
                // Update state
                currentState = newState;
                
                // Apply new state
                applyState(newState);
                
                console.log(`State transition: ${currentState} -> ${newState}`);
            }

            function cleanupState(state) {
                switch (state) {
                    case STATE.LISTENING:
                        // Ensure recognition is stopped
                        if (speechRecognition) {
                            try {
                                speechRecognition.stop();
                            } catch (e) {
                                // Ignore errors when stopping already stopped recognition
                            }
                        }
                        break;
                    case STATE.SPEAKING:
                        stopSpeaking();
                        break;
                }
            }

            function applyState(state) {
                // Reset UI elements
                resetUI();
                
                switch (state) {
                    case STATE.IDLE:
                        elements.orb.classList.add('orb--idle');
                        elements.statusMessage.textContent = 'Press the mic to start';
                        elements.toggleButton.disabled = false;
                        break;
                        
                    case STATE.LISTENING:
                        elements.orb.classList.add('orb--listening');
                        elements.statusMessage.textContent = 'Listening...';
                        elements.toggleButton.disabled = false;
                        break;
                        
                    case STATE.PROCESSING:
                        elements.orb.classList.add('orb--idle');
                        elements.processingIndicator.classList.remove('hidden');
                        elements.statusMessage.textContent = 'Processing your request...';
                        elements.toggleButton.disabled = true;
                        break;
                        
                    case STATE.SPEAKING:
                        elements.orb.classList.add('orb--speaking');
                        elements.statusMessage.textContent = 'Speaking...';
                        elements.toggleButton.disabled = false;
                        break;
                        
                    case STATE.ERROR:
                        elements.orb.classList.add('orb--error');
                        elements.statusMessage.textContent = 'An error occurred';
                        elements.toggleButton.disabled = false;
                        break;
                }
            }

            function resetUI() {
                elements.orb.className = 'orb';
                elements.processingIndicator.classList.add('hidden');
                elements.errorMessage.classList.add('hidden');
                elements.toggleButton.classList.remove('btn--disabled');
            }

            // --- Core Functions ---
            function startListening() {
                if (!speechRecognition) {
                    showError('Speech recognition is not available.');
                    return;
                }
                
                try {
                    speechRecognition.start();
                } catch (error) {
                    if (error.name === 'InvalidStateError') {
                        // Recognition already started, ignore
                        return;
                    }
                    showError('Failed to start speech recognition: ' + error.message);
                    transitionToState(STATE.ERROR);
                }
            }

            function stopListening() {
                if (speechRecognition) {
                    try {
                        speechRecognition.stop();
                    } catch (error) {
                        // Ignore errors when stopping recognition
                    console.warn('Error stopping recognition:', error);
                    transitionToState(STATE.IDLE);
                    return;
                }
                }
                transitionToState(STATE.IDLE);
            }

            async function processUserInput(userInput) {
                transitionToState(STATE.PROCESSING);
                
                try {
                    const response = await getAIResponse(userInput);
                    elements.responseMessage.textContent = response;
                    speakResponse(response);
                } catch (error) {
                    showError(`Failed to get response: ${error.message}`);
                    transitionToState(STATE.ERROR);
                }
            }

            async function getAIResponse(userInput) {
                if (!CONFIG.GEMINI.API_KEY) {
                    throw new Error('API key not configured. Please add your Gemini API key.');
                }
                
                // Add user message to history
                chatHistory.push({
                    role: "user",
                    parts: [{ text: userInput }]
                });
                
                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        temperature: CONFIG.GEMINI.TEMPERATURE,
                        maxOutputTokens: CONFIG.GEMINI.MAX_TOKENS,
                    }
                };
                
                const apiUrl = `${CONFIG.GEMINI.TEXT_API_URL}?key=${CONFIG.GEMINI.API_KEY}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error('Invalid response format from AI service');
                }
                
                const botResponse = data.candidates[0].content.parts[0].text;
                
                // Add bot response to history (limiting history length)
                chatHistory.push({
                    role: "model",
                    parts: [{ text: botResponse }]
                });
                
                // Keep chat history manageable (last 10 exchanges)
                if (chatHistory.length > 10) {
                    chatHistory.splice(2, 2); // Remove oldest exchange but keep system prompt
                }
                
                return botResponse;
            }

            function speakResponse(text) {
                if (!speechSynthesis) {
                    showError('Text-to-speech is not supported in this browser.');
                    transitionToState(STATE.IDLE);
                    return;
                }
                
                // Cancel any ongoing speech
                stopSpeaking();
                
                currentUtterance = new SpeechSynthesisUtterance(text);
                currentUtterance.rate = 0.9;
                currentUtterance.pitch = 1;
                currentUtterance.volume = 1;
                
                currentUtterance.onstart = () => {
                    transitionToState(STATE.SPEAKING);
                };
                
                currentUtterance.onend = () => {
                    currentUtterance = null;
                    transitionToState(STATE.IDLE);
                };
                
                currentUtterance.onerror = (event) => {
                    console.error('Speech synthesis error:', event);
                    currentUtterance = null;
                    showError('Speech synthesis failed');
                    transitionToState(STATE.ERROR);
                };
                
                speechSynthesis.speak(currentUtterance);
            }

            function stopSpeaking() {
                if (speechSynthesis && speechSynthesis.speaking) {
                    speechSynthesis.cancel();
                }
                if (currentUtterance) {
                    currentUtterance = null;
                }
            }

            // --- Utility Functions ---
            function showError(message) {
                console.error('Sophia Error:', message);
                elements.errorMessage.textContent = message;
                elements.errorMessage.classList.remove('hidden');
                
                // Auto-hide error after timeout
                setTimeout(() => {
                    elements.errorMessage.classList.add('hidden');
                }, CONFIG.UI.MESSAGE_TIMEOUT);
            }

            function disableToggleButton() {
                elements.toggleButton.disabled = true;
                elements.toggleButton.classList.add('btn--disabled');
            }

            function debounceButton() {
                isButtonDebouncing = true;
                setTimeout(() => {
                    isButtonDebouncing = false;
                }, CONFIG.UI.DEBOUNCE_DELAY);
            }

            function cleanupResources() {
                stopListening();
                stopSpeaking();
            }

            // --- Initialize Application ---
            document.addEventListener('DOMContentLoaded', init);
        })();
    </script>
</body>
</html>