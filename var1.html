<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health AI Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* A calming page background */
        }
        /* Floating bubble styles */
        #chat-bubble-toggle {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 4rem;
            height: 4rem;
            border-radius: 50%;
            background-color: #2563EB; /* blue-600 */
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease-in-out;
            z-index: 1000;
        }
        #chat-bubble-toggle:hover {
            background-color: #1D4ED8; /* blue-700 */
            transform: scale(1.1);
        }
        /* Chat widget container styles */
        #chat-widget-container {
            position: fixed;
            bottom: 7rem;
            right: 2rem;
            width: 100%;
            max-width: 648px; /* w-96 md:w-full md:max-w-xl lg:max-w-4xl */
            height: 75vh;
            max-height: 600px;
            opacity: 0;
            transform: translateY(20px);
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
        }
        #chat-widget-container.chat-open {
            opacity: 1;
            transform: translateY(0);
            visibility: visible;
        }

        .chat-bubble-user {
            background-color: #3B82F6; /* blue-500 */
            color: white;
        }
        .chat-bubble-bot {
            background-color: #E5E7EB; /* gray-200 */
            color: #1F2937; /* gray-800 */
        }
        .chat-container::-webkit-scrollbar {
            width: 6px;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background-color: #9CA3AF; /* gray-400 */
            border-radius: 3px;
        }
        .chat-container::-webkit-scrollbar-track {
            background-color: #F3F4F6; /* gray-100 */
        }
        .test-card-enter {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive adjustments for the widget */
        @media (max-width: 768px) {
            #chat-widget-container {
                right: 1rem;
                left: 1rem;
                bottom: 6rem;
                max-width: none;
            }
            #chat-bubble-toggle {
                right: 1rem;
                bottom: 1rem;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    
    <!-- This div is just for page content demonstration -->
    <div class="p-8">
        <h1 class="text-4xl font-bold text-gray-800">Your Website Content</h1>
        <p class="mt-4 text-gray-600">This is where the rest of your page would go. The chatbot is now a floating bubble in the bottom right corner.</p>
    </div>

    <!-- Chat Widget -->
    <div id="chat-widget-container" class="rounded-2xl shadow-2xl overflow-hidden">
        <div class="w-full h-full bg-white flex flex-col md:flex-row">
            <!-- Chatbot Interface (Now occupies the full widget) -->
            <div class="w-full flex flex-col h-full">
                <header class="bg-gray-800 text-white p-4 rounded-t-2xl flex items-center justify-between shadow-md">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center mr-3">
                           <svg class="w-6 h-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold">Health AI Assistant</h1>
                            <p class="text-sm text-gray-300">Your personal health guide</p>
                        </div>
                    </div>
                    <button id="close-chat-btn" class="text-gray-300 hover:text-white transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </header>

                <main id="chat-container" class="flex-1 p-6 overflow-y-auto chat-container bg-gray-50">
                    <!-- Chat messages will be appended here -->
                </main>

                <footer class="p-4 bg-white border-t border-gray-200">
                    <div id="quick-replies" class="flex flex-wrap gap-2 mb-3">
                        <!-- Quick replies will be appended here -->
                    </div>
                    <div class="flex items-center">
                        <input type="text" id="user-input" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="Type your symptoms...">
                        <button id="send-btn" class="ml-3 bg-blue-600 text-white px-6 py-3 rounded-xl hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition shadow-lg">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        </button>
                    </div>
                </footer>
            </div>

            <!-- Tests & Cart Section (Hidden by default on small screens, can be a tab later) -->
            <!-- For simplicity in this step, we are hiding this part. A more advanced version could use tabs -->
             <div class="hidden md:w-1/3 md:border-l md:border-gray-200 md:flex md:flex-col md:h-full bg-white rounded-r-2xl">
                <div class="p-4 border-b border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800">Suggested Tests</h2>
                    <p class="text-sm text-gray-500">Based on your conversation</p>
                </div>
                <div id="suggested-tests" class="flex-1 p-4 overflow-y-auto space-y-3 bg-gray-50">
                    <p id="no-tests-msg" class="text-center text-gray-500 mt-8">Start a conversation to get recommendations.</p>
                    <!-- Suggested tests will be appended here -->
                </div>
                <div class="p-4 border-t border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        Your Cart
                    </h2>
                    <div id="cart-items" class="mt-2 space-y-2">
                        <p id="empty-cart-msg" class="text-gray-500">Your cart is empty.</p>
                    </div>
                    <div class="mt-4">
                        <p class="text-lg font-semibold text-gray-800">Total: <span id="cart-total">â‚¦0.00</span></p>
                        <button class="w-full mt-2 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition shadow-md disabled:bg-gray-400" id="checkout-btn" disabled>Proceed to Checkout</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Chat Bubble -->
    <button id="chat-bubble-toggle">
        <svg id="chat-bubble-icon" class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
    </button>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const suggestedTestsContainer = document.getElementById('suggested-tests');
        const cartItemsContainer = document.getElementById('cart-items');
        const cartTotalEl = document.getElementById('cart-total');
        const checkoutBtn = document.getElementById('checkout-btn');
        const noTestsMsg = document.getElementById('no-tests-msg');
        const emptyCartMsg = document.getElementById('empty-cart-msg');
        const quickRepliesContainer = document.getElementById('quick-replies');
        
        // New elements for the widget functionality
        const chatWidgetContainer = document.getElementById('chat-widget-container');
        const chatBubbleToggle = document.getElementById('chat-bubble-toggle');
        const closeChatBtn = document.getElementById('close-chat-btn');

        // Toggle chat widget visibility
        chatBubbleToggle.addEventListener('click', () => {
            chatWidgetContainer.classList.toggle('chat-open');
        });
        closeChatBtn.addEventListener('click', () => {
            chatWidgetContainer.classList.remove('chat-open');
        });


        // --- GEMINI API INTEGRATION ---
        // IMPORTANT: The API key is left empty as per instructions for the execution environment.
        const GEMINI_API_KEY = "";
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;

        let conversationHistory = [];
        let cart = [];

        const testDatabase = {
            'CBC': { name: 'Complete Blood Count (CBC)', price: 75.00, description: 'Measures different components of your blood.' },
            'BMP': { name: 'Basic Metabolic Panel (BMP)', price: 90.00, description: 'Checks levels of certain substances in your blood.' },
            'LIPID': { name: 'Lipid Panel', price: 80.00, description: 'Measures fats and fatty substances in your blood.' },
            'THYROID': { name: 'Thyroid Panel', price: 120.00, description: 'Evaluates thyroid gland function.' },
            'URINALYSIS': { name: 'Urinalysis', price: 50.00, description: 'Analyzes your urine for various compounds.' },
            'VITD': { name: 'Vitamin D Test', price: 65.00, description: 'Measures the level of vitamin D in your blood.' }
        };
        
        const systemPrompt = `You are a friendly and helpful Health AI Assistant. Your goal is to understand a user's health symptoms and suggest relevant medical tests from a predefined list.

You MUST follow these rules:
1.  Your responses MUST be in JSON format.
2.  Do not use markdown in the JSON response.
3.  Keep your conversational messages concise and easy to understand.
4.  Ask clarifying questions one at a time to narrow down the symptoms.
5.  When you have enough information, suggest relevant tests.
6.  The available tests are: CBC, BMP, LIPID, THYROID, URINALYSIS, VITD. Only suggest tests from this list.
7.  Provide relevant quick reply options to guide the user.
8.  If the user's query is unrelated to health, politely steer the conversation back to symptoms.

The JSON output must follow this exact schema:
{
  "message": "Your conversational response to the user.",
  "suggestedTests": ["TEST_CODE_1", "TEST_CODE_2", ...],
  "quickReplies": ["Option 1", "Option 2", ...]
}

Example interaction:
User: "I have a bad headache"
Your JSON response:
{
  "message": "I'm sorry to hear that. To understand better, are you feeling any nausea or sensitivity to light?",
  "suggestedTests": [],
  "quickReplies": ["Yes, I have nausea", "Yes, sensitivity to light", "Both", "Neither"]
}`;


        const addMessage = (sender, message) => {
            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('flex', 'mb-4', sender === 'user' ? 'justify-end' : 'justify-start');
            
            const messageBubble = document.createElement('div');
            messageBubble.classList.add('rounded-xl', 'py-2', 'px-4', 'max-w-xs', 'lg:max-w-md', sender === 'user' ? 'chat-bubble-user' : 'chat-bubble-bot');
            messageBubble.innerText = message;
            
            messageWrapper.appendChild(messageBubble);
            chatContainer.appendChild(messageWrapper);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };

        const showTypingIndicator = () => {
             const typingWrapper = document.createElement('div');
             typingWrapper.id = 'typing-indicator';
             typingWrapper.classList.add('flex', 'mb-4', 'justify-start');
             typingWrapper.innerHTML = `
                <div class="chat-bubble-bot rounded-xl py-2 px-4">
                    <div class="flex items-center space-x-1">
                        <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: -0.3s;"></div>
                        <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: -0.15s;"></div>
                        <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce"></div>
                    </div>
                </div>
             `;
             chatContainer.appendChild(typingWrapper);
             chatContainer.scrollTop = chatContainer.scrollHeight;
        };

        const removeTypingIndicator = () => {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        };

        const updateQuickReplies = (replies = []) => {
            quickRepliesContainer.innerHTML = '';
            if (replies.length > 0) {
                replies.forEach(reply => {
                    const button = document.createElement('button');
                    button.textContent = reply;
                    button.classList.add('px-3', 'py-1', 'border', 'border-blue-500', 'text-blue-500', 'rounded-full', 'text-sm', 'hover:bg-blue-500', 'hover:text-white', 'transition');
                    button.onclick = () => handleUserInput(reply);
                    quickRepliesContainer.appendChild(button);
                });
            }
        };

        const processBotResponse = async (userInputText) => {
            conversationHistory.push({ role: "user", parts: [{ text: userInputText }] });

            try {
                const payload = {
                    contents: conversationHistory,
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };

                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.statusText}`);
                }

                const result = await response.json();
                const botResponseText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!botResponseText) {
                     throw new Error("Received an empty response from the API.");
                }

                const cleanedJsonString = botResponseText.replace(/```json|```/g, '').trim();
                const botResponseJson = JSON.parse(cleanedJsonString);
                
                conversationHistory.push({ role: "model", parts: [{ text: JSON.stringify(botResponseJson) }] });
                
                removeTypingIndicator();

                if (botResponseJson.message) {
                    addMessage('bot', botResponseJson.message);
                }
                if (botResponseJson.quickReplies) {
                    updateQuickReplies(botResponseJson.quickReplies);
                }
                if (botResponseJson.suggestedTests && botResponseJson.suggestedTests.length > 0) {
                    suggestTests(botResponseJson.suggestedTests);
                }

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                removeTypingIndicator();
                addMessage('bot', "I'm having a little trouble connecting right now. Please try again in a moment.");
            }
        };
        
        const handleUserInput = (inputText) => {
            const trimmedInput = inputText.trim();
            if (trimmedInput === '') return;

            addMessage('user', trimmedInput);
            userInput.value = '';
            updateQuickReplies(); 
            showTypingIndicator();
            
            processBotResponse(trimmedInput);
        };
        
        sendBtn.addEventListener('click', () => handleUserInput(userInput.value));
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleUserInput(userInput.value);
            }
        });

        const suggestTests = (testCodes) => {
            noTestsMsg.classList.add('hidden');
            testCodes.forEach(code => {
                const test = testDatabase[code];
                if (!test || document.querySelector(`.add-to-cart-btn[data-code="${code}"]`)) return;

                const card = document.createElement('div');
                card.classList.add('p-4', 'bg-white', 'rounded-lg', 'shadow-md', 'border', 'border-gray-200', 'test-card-enter');
                card.innerHTML = `
                    <h3 class="font-bold text-md text-gray-800">${test.name}</h3>
                    <p class="text-sm text-gray-600 my-1">${test.description}</p>
                    <div class="flex justify-between items-center mt-3">
                        <span class="text-lg font-semibold text-blue-600">$${test.price.toFixed(2)}</span>
                        <button class="add-to-cart-btn bg-blue-100 text-blue-700 px-4 py-1 rounded-md text-sm font-semibold hover:bg-blue-200 transition" data-code="${code}">Add to Cart</button>
                    </div>
                `;
                suggestedTestsContainer.prepend(card);
            });

            document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                button.onclick = (e) => {
                    const code = e.target.dataset.code;
                    addToCart(code);
                    e.target.textContent = 'Added!';
                    e.target.disabled = true;
                    e.target.classList.remove('bg-blue-100', 'hover:bg-blue-200');
                    e.target.classList.add('bg-green-100', 'text-green-700');
                };
            });
        };

        const addToCart = (testCode) => {
            const test = testDatabase[testCode];
            if (test && !cart.find(item => item.code === testCode)) {
                cart.push({ ...test, code: testCode });
                updateCart();
            }
        };

        const removeFromCart = (testCode) => {
            cart = cart.filter(item => item.code !== testCode);

            const addButton = document.querySelector(`.add-to-cart-btn[data-code="${testCode}"]`);
            if(addButton){
                addButton.textContent = 'Add to Cart';
                addButton.disabled = false;
                addButton.classList.add('bg-blue-100', 'hover:bg-blue-200');
                addButton.classList.remove('bg-green-100', 'text-green-700');
            }

            updateCart();
        };

        const updateCart = () => {
            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '';
                emptyCartMsg.classList.remove('hidden');
                checkoutBtn.disabled = true;
            } else {
                emptyCartMsg.classList.add('hidden');
                cartItemsContainer.innerHTML = '';
                cart.forEach(item => {
                    const cartItem = document.createElement('div');
                    cartItem.classList.add('flex', 'justify-between', 'items-center', 'text-sm');
                    cartItem.innerHTML = `
                        <span class="text-gray-700">${item.name}</span>
                        <div class="flex items-center">
                            <span class="font-semibold text-gray-800 mr-2">$${item.price.toFixed(2)}</span>
                            <button class="text-red-500 hover:text-red-700 remove-from-cart-btn" data-code="${item.code}">&times;</button>
                        </div>
                    `;
                    cartItemsContainer.appendChild(cartItem);
                });
                checkoutBtn.disabled = false;
            }

            document.querySelectorAll('.remove-from-cart-btn').forEach(button => {
                button.onclick = (e) => {
                    removeFromCart(e.target.dataset.code);
                };
            });

            const total = cart.reduce((sum, item) => sum + item.price, 0);
            cartTotalEl.textContent = `$${total.toFixed(2)}`;
        };
        
        // Initial bot message
        window.onload = () => {
             const initialMessage = "Hello! I'm your Health AI Assistant, powered by Gemini. I can help you understand your symptoms. What's your main symptom today?";
             const initialReplies = ['Headache', 'Fever', 'Stomach Pain', 'Fatigue'];
             
             conversationHistory.push({
                role: "model",
                parts: [{ text: JSON.stringify({ message: initialMessage, suggestedTests: [], quickReplies: initialReplies }) }]
             });
            addMessage('bot', initialMessage);
            updateQuickReplies(initialReplies);
        };
    </script>
</body>
</html>

