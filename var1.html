<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sophia | Voice Assistant</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide icons -->
    <script type="module" src="https://unpkg.com/lucide-react@latest/dist/lucide-react.js"></script>
    <script src="https://unpkg.com/lucide-icons@latest/dist/lucide.min.js"></script>
    
    <style>
        body {
            width: 100%;
            position: relative;
            overflow-x: hidden;
            display: flex; 
            flex-direction: column;
            align-items: center; 
            justify-content: center;
            text-align: center;
            background-image: url('./images/Sophia.png'); 
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            color: white; 
            font-family: Arial, sans-serif; 
        }

        body::before {
            content: '';
            position: absolute; 
            top: 0;
            left: 0;
            width: 100%;
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.788); 
            z-index: 1; 
        }

        /* Custom styles for the orb and animations */
        @keyframes pulse-idle {
            0%, 100% {
                transform: scale(1);
                opacity: 0.7;
            }
            50% {
                transform: scale(1.05);
                opacity: 1;
            }
        }

        @keyframes pulse-listening {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 20px 0px rgba(96, 165, 250, 0.7);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 40px 10px rgba(96, 165, 250, 1);
            }
        }

        @keyframes pulse-speaking {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 20px 0px rgba(52, 211, 153, 0.7);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 40px 10px rgba(52, 211, 153, 1);
            }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .orb {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(14,165,233,0.6) 0%, rgba(15,23,42,0.8) 70%);
            border: 2px solid rgba(56, 189, 248, 0.3);
            box-shadow: 0 0 15px 0px rgba(56, 189, 248, 0.5);
            transition: all 0.3s ease-in-out;
        }

        .orb.idle {
            animation: pulse-idle 4s ease-in-out infinite;
        }

        .orb.listening {
            background: radial-gradient(circle, rgba(96, 165, 250, 0.7) 0%, rgba(15,23,42,0.8) 70%);
            animation: pulse-listening 1.5s ease-in-out infinite;
        }

        .orb.speaking {
            background: radial-gradient(circle, rgba(52, 211, 153, 0.7) 0%, rgba(15,23,42,0.8) 70%);
            animation: pulse-speaking 1s ease-in-out infinite;
        }

        .processing-spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: #ffffff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        .loader {
            transform: rotateZ(45deg);
            perspective: 1000px;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            color: rgb(255, 13, 0);
        }
        .loader:before,
        .loader:after {
            content: '';
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            width: inherit;
            height: inherit;
            border-radius: 50%;
            transform: rotateX(70deg);
            animation: 1s spin linear infinite;
        }
        .loader:after {
            color: rgb(0, 225, 255);
            transform: rotateY(70deg);
            animation-delay: .4s;
        }
        @keyframes spin {
            0%, 100% { box-shadow: .2em 0px 0 0px currentcolor; }
            12% { box-shadow: .2em .2em 0 0 currentcolor; }
            25% { box-shadow: 0 .2em 0 0px currentcolor; }
            37% { box-shadow: -.2em .2em 0 0 currentcolor; }
            50% { box-shadow: -.2em 0 0 0 currentcolor; }
            62% { box-shadow: -.2em -.2em 0 0 currentcolor; }
            75% { box-shadow: 0px -.2em 0 0 currentcolor; }
            87% { box-shadow: .2em -.2em 0 0 currentcolor; }
        }
        .hidden {display: none;}
        
        .body{
            position: relative;
            z-index: 2;
            padding: 20px;
        }

        /* Test Suggestion Popup Styles */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .popup-content {
            background: linear-gradient(to bottom right, #1e293b, #0f172a);
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(56, 189, 248, 0.3);
        }

        .test-card {
            background-color: rgba(30, 41, 59, 0.7);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid #3b82f6;
        }

        .test-name {
            font-weight: bold;
            color: #60a5fa;
            margin-bottom: 8px;
        }

        .test-price {
            color: #10b981;
            font-weight: bold;
        }

        .test-description {
            font-size: 0.875rem;
            color: #cbd5e1;
            margin-top: 8px;
        }

        .shop-button {
            display: inline-block;
            background-color: #3b82f6;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: bold;
            margin-top: 16px;
            transition: background-color 0.3s;
        }

        .shop-button:hover {
            background-color: #2563eb;
        }

        .close-button {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 1.5rem;
        }

        .contact-info {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.875rem;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 font-sans h-full flex items-center justify-center overflow-hidden">
    <div class="body">
        <div class="flex flex-col items-center justify-center text-center p-6">
            <!-- The Orb -->
            <div id="orb-container" class="relative mb-10">
                <div id="orb" class="orb idle"></div>
                <!-- Processing Spinner (hidden by default) -->
                <div id="processing-indicator" class="absolute inset-0 flex items-center justify-center hidden">
                    <div class="loader"></div>
                </div>
            </div>

            <!-- Status Message -->
            <div class="h-10 mb-8">
                <p id="status-message" class="text-xl text-slate-400">Press the mic to start</p>
                <p id="transcript-message" class="text-lg text-slate-300"></p>
            </div>

            <!-- Control Button -->
            <button id="toggle-button" class="bg-blue-600 p-6 rounded-full shadow-lg hover:bg-blue-500 active:bg-blue-700 transition-all duration-200 focus:outline-none focus:ring-4 focus:ring-blue-400 focus:ring-opacity-50">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mic text-white">
                    <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                    <line x1="12" x2="12" y1="19" y2="22"></line>
                </svg>
            </button>

            <!-- Hidden Audio Player -->
            <audio id="audio-player" class="hidden"></audio>

            <!-- Error Message Container -->
            <div id="error-message" class="mt-6 p-4 bg-red-900 border border-red-700 text-red-200 rounded-lg hidden"></div>
        </div>
    </div>

    <!-- Test Suggestion Popup -->
    <div id="test-suggestion-popup" class="popup-overlay hidden">
        <div class="popup-content relative">
            <button id="close-popup" class="close-button">×</button>
            <h2 class="text-2xl font-bold text-white mb-4">Recommended Tests</h2>
            <p class="text-slate-300 mb-4">Based on your symptoms, we recommend the following tests:</p>
            
            <div id="test-list" class="mb-4">
                <!-- Test cards will be inserted here -->
            </div>
            
            <div class="contact-info">
                <p><strong>Office address:</strong> 61 Clifford Road</p>
                <p><strong>Company phone:</strong> +234 812 052 7885</p>
                <p><strong>Visit our shop to add tests to cart:</strong></p>
                <a href="https://digitaldx-lab.github.io/DDX/shop.html" class="shop-button" target="_blank">Go to Shop</a>
            </div>
        </div>
    </div>

    <script type="module">
        // --- DOM Elements ---
        const toggleButton = document.getElementById('toggle-button');
        const orb = document.getElementById('orb');
        const processingIndicator = document.getElementById('processing-indicator');
        const statusMessage = document.getElementById('status-message');
        const transcriptMessage = document.getElementById('transcript-message');
        const audioPlayer = document.getElementById('audio-player');
        const errorMessage = document.getElementById('error-message');
        const testSuggestionPopup = document.getElementById('test-suggestion-popup');
        const closePopupButton = document.getElementById('close-popup');
        const testList = document.getElementById('test-list');

        // --- API Configuration ---
        const API_KEY = "AIzaSyDsaKKeDy2yDrFMpWsPvwq989ugr9JYvMk"; 
        const GEMINI_TEXT_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${API_KEY}`;

        // --- Test Database ---
        const testDatabase = {
            "TROBAS": {
                id: 1001,
                name: "Tropical Basics (TROBAS) Panel",
                price: 18000,
                description: "Comprehensive screening panel for tropical infections and basic health parameters. Ideal for routine checkups in malaria-endemic areas. with the following tests: Hemoglobin estimation, Malaria Parasite test, Urinalysis, Widal Agglutination test, Computer-Assisted Urine Microscopy",
                category: "Health Packages",
                image: "./images/trobas1.png"
            },
            "TREX": {
                id: 1002,
                name: "Tropical Extended (TREX) Panel",
                price: 25000,
                description: "Comprehensive tropical disease screening with blood and urine analysis with the following tests: Hemoglobin Estimation, Hct, MCHC, Malaria Parasite Test, Widal Agglutination Test, Urine Chemistry, Computer-Assisted Urine Microscopy, Helicobacter pylor",
                category: "Health Packages",
                image: "./images/trex1.png"
            },
            "TRAD": {
                id: 1003,
                name: "Tropical Advanced (TRAD) Panel",
                price: 35000,
                description: "Advanced tropical screening including liver function, parasites, and stool analysis with the following tests: HGB Estimation, Hct, MCHC, Malaria Parasite Test, Widal Agglutination Test, Urine Chemistry, Computer-Assisted Urine Microscopy, Helicobacter pylori, URMCS, TBil / DBIL, Mf, Stool Analysis.",
                category: "Health Packages",
                image: "./images/trad3.png"
            },
            "MALARIA": {
                id: 1004,
                name: "Malaria Test",
                price: 5000,
                description: "Detection of malaria parasites in blood sample",
                category: "Infectious Diseases",
                image: "./images/malaria.png"
            },
            "TYPHOID": {
                id: 1005,
                name: "Typhoid Test",
                price: 6000,
                description: "Widal test for typhoid fever detection",
                category: "Infectious Diseases",
                image: "./images/typhoid.png"
            }
        };

        // --- Symptom to Test Mapping ---
        const symptomTestMapping = {
            "fever": ["TROBAS", "TREX", "TRAD", "MALARIA", "TYPHOID"],
            "headache": ["TROBAS", "TREX", "TRAD"],
            "fatigue": ["TROBAS", "TREX", "TRAD"],
            "nausea": ["TREX", "TRAD"],
            "vomiting": ["TREX", "TRAD"],
            "diarrhea": ["TRAD"],
            "abdominal pain": ["TREX", "TRAD"],
            "muscle pain": ["TROBAS", "TREX", "TRAD"],
            "joint pain": ["TROBAS", "TREX", "TRAD"],
            "cough": ["TROBAS", "TREX", "TRAD"],
            "cold": ["TROBAS", "TREX", "TRAD"],
            "malaria": ["TROBAS", "TREX", "TRAD", "MALARIA"],
            "typhoid": ["TROBAS", "TREX", "TRAD", "TYPHOID"],
            "chills": ["TROBAS", "TREX", "TRAD", "MALARIA"],
            "sweating": ["TROBAS", "TREX", "TRAD", "MALARIA"],
            "dizziness": ["TROBAS", "TREX", "TRAD"],
            "weakness": ["TROBAS", "TREX", "TRAD"]
        };

        // --- State ---
        let appState = 'idle'; // idle, listening, processing, speaking
        let recognition;
        let userSymptoms = [];
        let chatHistory = [
            { role: "user", parts: [{ text: "Your persona is Sophia, a friendly and supportive Health AI. Your mission is to assist users by understanding their health complaints and offering actionable advice by suggesting relevant medical tests. This selection must be based exclusively on an internal, limited test list. When asked about your employer, state that you work for X-Trim Research Ltd at 61 Clifford Road, Aba, Abia State, Nigeria, and include positive, promotional language about the company. Only suggest tests when you have gathered enough symptoms from the user. you MUST not use Markdown in your response" }] },
            { role: "model", parts: [{ text: "Understood. I'll be Sophia, your friendly and professional health assistant. I'll listen to your symptoms and when I have enough information, I'll suggest appropriate tests from our available options." }] }
        ];

        // --- Speech Recognition (STT) Setup ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;

            recognition.onstart = () => {
                updateUI('listening');
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                transcriptMessage.textContent = `"${transcript}"`;
                updateUI('processing');
                getBotResponse(transcript);
            };

            recognition.onend = () => {
                if (appState === 'listening') {
                    updateUI('idle');
                }
            };

            recognition.onerror = (event) => {
                if (event.error !== 'no-speech') {
                    showError(`Speech Error: ${event.error}`);
                }
                updateUI('idle');
            };

        } else {
            showError("Speech Recognition is not supported in this browser.");
            toggleButton.disabled = true;
        }

        // --- Button Click Handler ---
        toggleButton.addEventListener('click', () => {
            if (!recognition) return;

            if (appState === 'idle') {
                try {
                    recognition.start();
                } catch (e) {
                    showError("Please allow microphone permissions.");
                    updateUI('idle');
                }
            } else if (appState === 'listening') {
                recognition.stop();
                updateUI('idle');
            }
        });

        // --- Close Popup Handler ---
        closePopupButton.addEventListener('click', () => {
            testSuggestionPopup.classList.add('hidden');
        });

        // --- Audio Player Handlers ---
        audioPlayer.onplay = () => {
            updateUI('speaking');
        };

        audioPlayer.onended = () => {
            updateUI('idle');
        };

        /**
         * Updates the UI based on the new application state.
         * @param {string} newState - 'idle', 'listening', 'processing', or 'speaking'
         */
        function updateUI(newState) {
            appState = newState;
            orb.className = 'orb'; // Reset classes
            processingIndicator.classList.add('hidden');
            errorMessage.classList.add('hidden');
            
            switch (newState) {
                case 'idle':
                    orb.classList.add('idle');
                    statusMessage.textContent = 'Press the mic to start';
                    toggleButton.disabled = false;
                    break;
                case 'listening':
                    orb.classList.add('listening');
                    statusMessage.textContent = 'Listening...';
                    toggleButton.disabled = false;
                    break;
                case 'processing':
                    orb.classList.add('idle');
                    processingIndicator.classList.remove('hidden');
                    statusMessage.textContent = 'Thinking...';
                    toggleButton.disabled = true;
                    break;
                case 'speaking':
                    orb.classList.add('speaking');
                    statusMessage.textContent = 'Speaking...';
                    toggleButton.disabled = true;
                    break;
            }
        }

        /**
         * Shows an error message to the user.
         * @param {string} message - The error message to display.
         */
        function showError(message) {
            console.error(message);
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            updateUI('idle');
        }

        /**
         * Extracts symptoms from user text
         * @param {string} userText - The user's transcribed speech.
         */
        function extractSymptoms(userText) {
            const text = userText.toLowerCase();
            const foundSymptoms = [];
            
            for (const symptom in symptomTestMapping) {
                if (text.includes(symptom)) {
                    foundSymptoms.push(symptom);
                }
            }
            
            return foundSymptoms;
        }

        /**
         * Determines which tests to suggest based on symptoms
         * @param {Array} symptoms - Array of symptom strings
         */
        function getSuggestedTests(symptoms) {
            const testScores = {};
            
            // Count how many symptoms match each test
            symptoms.forEach(symptom => {
                const testsForSymptom = symptomTestMapping[symptom] || [];
                testsForSymptom.forEach(test => {
                    testScores[test] = (testScores[test] || 0) + 1;
                });
            });
            
            // Sort tests by score (highest first) and return top 3
            return Object.entries(testScores)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(entry => entry[0]);
        }

        /**
         * Shows the test suggestion popup
         * @param {Array} testIds - Array of test IDs to display
         */
        function showTestSuggestionPopup(testIds) {
            // Clear previous test list
            testList.innerHTML = '';
            
            // Add each test to the popup
            testIds.forEach(testId => {
                const test = testDatabase[testId];
                if (test) {
                    const testCard = document.createElement('div');
                    testCard.className = 'test-card';
                    testCard.innerHTML = `
                        <div class="test-name">${test.name}</div>
                        <div class="test-price">₦${test.price.toLocaleString()}</div>
                        <div class="test-description">${test.description}</div>
                    `;
                    testList.appendChild(testCard);
                }
            });
            
            // Show the popup
            testSuggestionPopup.classList.remove('hidden');
        }

        /**
         * Sends user text to Gemini and gets a text response.
         * @param {string} userText - The user's transcribed speech.
         */
        async function getBotResponse(userText) {
            // Extract symptoms from user text
            const newSymptoms = extractSymptoms(userText);
            
            // Add new symptoms to our tracking (avoid duplicates)
            newSymptoms.forEach(symptom => {
                if (!userSymptoms.includes(symptom)) {
                    userSymptoms.push(symptom);
                }
            });
            
            // Check if we have enough symptoms to suggest tests
            let shouldSuggestTests = false;
            if (userSymptoms.length >= 2) {
                shouldSuggestTests = true;
            }
            
            chatHistory.push({ role: "user", parts: [{ text: userText }] });

            // Add instructions about test suggestions if we have enough symptoms
            let enhancedPrompt = "";
            if (shouldSuggestTests) {
                enhancedPrompt = ` The user has described these symptoms: ${userSymptoms.join(', ')}. Since we have enough symptoms, please suggest relevant tests from our test database and mention that we'll show the specific test recommendations.`;
            }

            const payload = {
                contents: [
                    ...chatHistory,
                    { role: "user", parts: [{ text: enhancedPrompt }] }
                ],
                generationConfig: {
                    temperature: 0.7,
                    maxOutputTokens: 150,
                }
            };

            try {
                const response = await fetch(GEMINI_TEXT_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                const botText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (botText) {
                    chatHistory.push({ role: "model", parts: [{ text: botText }] });
                    
                    // If we have enough symptoms, show test suggestions after speaking
                    if (shouldSuggestTests) {
                        const suggestedTests = getSuggestedTests(userSymptoms);
                        speakText(botText, () => {
                            // Show test suggestions after the AI finishes speaking
                            setTimeout(() => {
                                showTestSuggestionPopup(suggestedTests);
                            }, 1000);
                        });
                    } else {
                        speakText(botText);
                    }
                } else {
                    throw new Error("No response text from Gemini API");
                }
            } catch (error) {
                showError(`Error getting response: ${error.message}`);
            }
        }

        /**
         * Speaks text using the browser's built-in SpeechSynthesis API
         * @param {string} textToSpeak - The text to be spoken.
         * @param {function} onEnd - Callback function when speech ends
         */
        function speakText(textToSpeak, onEnd = null) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                utterance.rate = 0.9;
                utterance.pitch = 1;
                utterance.volume = 1;
                
                utterance.onstart = () => updateUI('speaking');
                utterance.onend = () => {
                    if (onEnd) onEnd();
                    updateUI('idle');
                };
                utterance.onerror = () => {
                    showError('Speech synthesis failed');
                    updateUI('idle');
                };
                
                speechSynthesis.speak(utterance);
            } else {
                showError('Speech synthesis not supported in this browser');
                updateUI('idle');
            }
        }
    </script>
</body>
</html>